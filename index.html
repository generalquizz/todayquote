<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Today Quote & Secure Chat</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
.header { background:#222; color:#fff; padding:20px; text-align:center; font-size:24px; }
.hidden-button { position:fixed; bottom:10px; left:10px; color:#f5f5f5; border:none; background:#f5f5f5; cursor:pointer; }
.chat-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
.chat-box { background:#fff; width:400px; height:500px; display:flex; flex-direction:column; border-radius:10px; overflow:hidden; }
.chat-messages { flex:1; padding:10px; overflow-y:auto; }
.msg { padding:5px 10px; margin:5px 0; border-radius:5px; max-width:80%; }
.me { background:#a0e7e5; margin-left:auto; }
.other { background:#ffaeae; margin-right:auto; }
.chat-input { display:flex; }
.chat-input input { flex:1; padding:10px; border:none; border-top:1px solid #ccc; }
.chat-input button { padding:10px; border:none; background:#222; color:#fff; cursor:pointer; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="header">حكمة اليوم: لا تؤجل عمل اليوم إلى الغد</div>
<button class="hidden-button" id="openChat">.</button>
<div class="chat-overlay" id="chatOverlay">
  <div class="chat-box">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatText" placeholder="اكتب رسالتك...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>
<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDBADAFbHjg8Dq10vR1l9yMImoBSFs_70M",
  authDomain: "todayquote-3a22b.firebaseapp.com",
  databaseURL: "https://todayquote-3a22b-default-rtdb.firebaseio.com",
  projectId: "todayquote-3a22b",
  storageBucket: "todayquote-3a22b.firebasestorage.app",
  messagingSenderId: "10962691980",
  appId: "1:10962691980:web:a38f4e91310cccba0998a9",
  measurementId: "G-WB9434WPCX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const chatRef = db.ref('chat');

// User ID for distinguishing messages
let userId = localStorage.getItem('uid');
if(!userId){ userId = crypto.randomUUID(); localStorage.setItem('uid', userId); }

// Encryption utilities (simple AES-GCM)
async function getKey(){
  let raw = new TextEncoder().encode(userId);
  return crypto.subtle.importKey('raw', raw, {name:'AES-GCM'}, false, ['encrypt','decrypt']);
}
async function encrypt(msg,key){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder().encode(msg);
  const m = await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, enc);
  return {m:btoa(String.fromCharCode(...new Uint8Array(m))), iv:btoa(String.fromCharCode(...iv))};
}
async function decrypt(m,iv,key){
  const decrypted = await crypto.subtle.decrypt({
    name:'AES-GCM',
    iv: new Uint8Array(atob(iv).split('').map(c=>c.charCodeAt(0)))
  }, key, new Uint8Array(atob(m).split('').map(c=>c.charCodeAt(0))));
  return new TextDecoder().decode(decrypted);
}

// Chat Elements
const overlay = document.getElementById('chatOverlay');
const openBtn = document.getElementById('openChat');
const sendBtn = document.getElementById('sendBtn');
const text = document.getElementById('chatText');
const box = document.getElementById('chatMessages');

// Open Chat with password prompt
openBtn.addEventListener('click',()=>{
  const pwd = prompt('ادخل كلمة المرور');
  if(pwd==='blobif') overlay.style.display='flex';
});

// Send message
sendBtn.addEventListener('click', send);
text.addEventListener('keypress', e=>{if(e.key==='Enter') send();});
async function send(){
  const t = text.value.trim();
  if(!t) return;
  text.value='';
  const key = await getKey();
  const e = await encrypt(t,key);
  const msgRef = chatRef.push();
  await msgRef.set({ u:userId, m:e.m, iv:e.iv, ts:firebase.database.ServerValue.TIMESTAMP });
}

// Listen for new messages
chatRef.on('child_added', async snap=>{
  const d = snap.val();
  if(!d) return;
  const key = await getKey();
  const txt = await decrypt(d.m,d.iv,key);
  const div = document.createElement('div');
  div.className = 'msg ' + (d.u===userId?'me':'other');
  div.textContent = txt;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  // Remove message from UI after 5 seconds
  setTimeout(()=>{ div.remove(); },5000);
});
</script>
</body>
</html>
