<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Private Chat</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Tahoma,Arial;background:#f4f4f4}
header{background:#222;color:#fff;padding:22px;text-align:center}
#secretBtn{position:fixed;bottom:12px;left:12px;width:40px;height:40px;
background:#f4f4f4;border:none;cursor:pointer;z-index:1000}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);
justify-content:center;align-items:center;z-index:2000}
.box{background:#fff;width:90%;max-width:360px;padding:20px;
border-radius:12px;text-align:center}
input,button{width:100%;padding:12px;font-size:16px;margin-top:10px}
button{background:#222;color:#fff;border:none;border-radius:8px}
#chatBox{width:100%;max-width:420px;height:100%;max-height:600px;
background:#fff;display:flex;flex-direction:column;border-radius:14px}
#messages{flex:1;padding:12px;overflow-y:auto}
.msg{margin:8px 0;padding:10px 14px;border-radius:18px;max-width:80%}
.me{background:#d1f1ff;margin-left:auto}
.other{background:#eee;margin-right:auto}
#inputArea{display:flex;border-top:1px solid #ccc}
#inputArea input{flex:1;border:none}
#inputArea button{width:auto;padding:0 18px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>

<body>

<header>حكمة اليوم: الخصوصية تبدأ بالتحكم</header>
<button id="secretBtn"></button>

<div id="passOverlay" class="overlay">
  <div class="box">
    <div>أدخل كلمة المرور</div>
    <input id="passInput" type="password">
    <button id="passBtn">دخول</button>
  </div>
</div>

<div id="blockOverlay" class="overlay">
  <div class="box">⚠️ الشات مستخدم بين طرفين فقط</div>
</div>

<div id="chatOverlay" class="overlay">
  <div id="chatBox">
    <div style="background:#222;color:#fff;padding:10px;text-align:center">
      Secure Chat
    </div>
    <div id="messages"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="اكتب رسالة...">
      <button id="sendBtn">إرسال</button>
    </div>
  </div>
</div>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDBADAFbHjg8Dq10vR1l9yMImoBSFs_70M",
  authDomain: "todayquote-3a22b.firebaseapp.com",
  databaseURL: "https://todayquote-3a22b-default-rtdb.firebaseio.com",
  projectId: "todayquote-3a22b",
  storageBucket: "todayquote-3a22b.firebasestorage.app",
  messagingSenderId: "10962691980",
  appId: "1:10962691980:web:a38f4e91310cccba0998a9"
};
firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously();
const db = firebase.database();

/* ================= UID ================= */
let uid = localStorage.getItem("uid");
if(!uid){
  uid = Math.random().toString(36).slice(2);
  localStorage.setItem("uid", uid);
}

/* ================= Refs ================= */
const lockRef = db.ref("lock");
const chatRef = db.ref("chat");
const keyRef  = db.ref("sessionKey");

/* ================= DOM ================= */
const secretBtn = document.getElementById("secretBtn");
const passOverlay = document.getElementById("passOverlay");
const chatOverlay = document.getElementById("chatOverlay");
const blockOverlay = document.getElementById("blockOverlay");
const passBtn = document.getElementById("passBtn");
const passInput = document.getElementById("passInput");
const sendBtn = document.getElementById("sendBtn");
const msgInput = document.getElementById("msgInput");
const messages = document.getElementById("messages");

secretBtn.onclick = () => passOverlay.style.display = "flex";
passBtn.onclick = enterChat;
passInput.onkeyup = e => { if(e.key==="Enter") enterChat(); };

/* ================= Crypto ================= */
let sessionKey = null;

async function genKey(){
  return crypto.subtle.generateKey(
    {name:"AES-GCM",length:256}, true, ["encrypt","decrypt"]
  );
}
function b64(b){return btoa(String.fromCharCode(...new Uint8Array(b)))}
function ub64(s){return Uint8Array.from(atob(s),c=>c.charCodeAt(0))}
async function encrypt(txt){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt(
    {name:"AES-GCM",iv}, sessionKey, new TextEncoder().encode(txt)
  );
  return {iv:b64(iv), ct:b64(ct)};
}
async function decrypt(p){
  const pt = await crypto.subtle.decrypt(
    {name:"AES-GCM",iv:ub64(p.iv)}, sessionKey, ub64(p.ct)
  );
  return new TextDecoder().decode(pt);
}

/* ================= دخول الشات (الإصلاح الحقيقي) ================= */
async function enterChat(){
  if(passInput.value !== "blobif") return;

  try{
    const result = await lockRef.transaction(cur=>{
      cur = cur || {};
      if(cur[uid]) return cur;
      if(Object.keys(cur).length >= 2) return;
      cur[uid] = true;
      return cur;
    });

    if(!result.committed){
      passOverlay.style.display="none";
      blockOverlay.style.display="flex";
      return;
    }

    lockRef.child(uid).onDisconnect().remove();

    const snap = await keyRef.once("value");
    if(!snap.exists()){
      sessionKey = await genKey();
      const raw = await crypto.subtle.exportKey("raw", sessionKey);
      await keyRef.set(b64(raw));
      keyRef.onDisconnect().remove();
    }else{
      sessionKey = await crypto.subtle.importKey(
        "raw", ub64(snap.val()), "AES-GCM", false, ["encrypt","decrypt"]
      );
    }

    passOverlay.style.display="none";
    chatOverlay.style.display="flex";

  }catch(e){
    console.error(e);
    lockRef.child(uid).remove();
    passOverlay.style.display="flex";
  }
}

/* ================= رسائل ================= */
sendBtn.onclick = sendMsg;
msgInput.onkeyup = e => { if(e.key==="Enter") sendMsg(); };

async function sendMsg(){
  if(!msgInput.value.trim()) return;
  const payload = await encrypt(msgInput.value);
  const r = chatRef.push();
  await r.set({payload,uid});
  setTimeout(()=>r.remove(),5000);
  msgInput.value="";
}

chatRef.on("child_added", async s=>{
  const d=s.val(); if(!d) return;
  const m=document.createElement("div");
  m.className="msg "+(d.uid===uid?"me":"other");
  m.textContent=await decrypt(d.payload);
  messages.appendChild(m);
  messages.scrollTop=messages.scrollHeight;
  setTimeout(()=>m.remove(),5000);
});

/* ================= تنظيف ================= */
lockRef.on("child_removed",()=>{
  lockRef.once("value").then(s=>{
    if(!s.exists()){
      chatRef.remove();
      keyRef.remove();
    }
  });
});
</script>

</body>
</html>
