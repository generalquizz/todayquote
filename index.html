<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Today Quote</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Tahoma, Arial;background:#f4f4f4;color:#333}
header{background:#222;color:#fff;padding:25px 10px;text-align:center}
#quote{font-size:18px;line-height:1.6}
#secretBtn{position:fixed;bottom:12px;left:12px;width:40px;height:40px;background:#f4f4f4;border:none;cursor:pointer;z-index:1000}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:2000}
.box{background:#fff;width:90%;max-width:340px;padding:20px;border-radius:10px;text-align:center}
input,button{width:100%;padding:12px;font-size:16px;margin-top:10px}
button{background:#222;color:#fff;border:none}
#chatBox{width:100%;max-width:420px;height:100%;max-height:600px;background:#fff;display:flex;flex-direction:column}
#chatHeader{background:#222;color:#fff;padding:12px;text-align:center}
#messages{flex:1;padding:12px;overflow-y:auto}
.msg{margin:8px 0;padding:10px 14px;border-radius:18px;max-width:80%;font-size:14px;word-wrap:break-word}
.me{background:#d1f1ff;margin-left:auto}
.other{background:#eee;margin-right:auto}
#inputArea{display:flex;border-top:1px solid #ccc}
#inputArea input{flex:1;border:none}
#inputArea button{width:auto;padding:0 18px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
<header><div id="quote">حكمة اليوم: الخصوصية تبدأ بالتحكم</div></header>
<button id="secretBtn"></button>

<div id="passOverlay" class="overlay"><div class="box"><div>أدخل كلمة المرور</div><input id="passInput" type="password"><button id="passBtn">دخول</button></div></div>
<div id="blockOverlay" class="overlay"><div class="box">⚠️ الشات مستخدم حالياً بين طرفين فقط</div></div>
<div id="chatOverlay" class="overlay"><div id="chatBox"><div id="chatHeader">Private Chat</div><div id="messages"></div><div id="inputArea"><input id="msgInput" placeholder="اكتب رسالة..."><button id="sendBtn">إرسال</button></div></div></div>

<script>
// ====== السبب الحقيقي للمشكلة ======
// قراءة presence كانت تفشل بصمت بسبب قواعد Firebase، فـ once('value') لا يُكمل => زر الدخول يبدو معطلاً.
// الحل: استخدام Transaction ذريّة على مسار القفل دون قراءة مسبقة.

const firebaseConfig={
 apiKey:"AIzaSyDBADAFbHjg8Dq10vR1l9yMImoBSFs_70M",
 authDomain:"todayquote-3a22b.firebaseapp.com",
 databaseURL:"https://todayquote-3a22b-default-rtdb.firebaseio.com",
 projectId:"todayquote-3a22b",
 storageBucket:"todayquote-3a22b.firebasestorage.app",
 messagingSenderId:"10962691980",
 appId:"1:10962691980:web:a38f4e91310cccba0998a9"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

firebase.auth().signInAnonymously().catch(console.error);

let uid=localStorage.getItem('uid');
if(!uid){uid=Math.random().toString(36).slice(2);localStorage.setItem('uid',uid)}

const lockRef=db.ref('lock'); // يحتوي على المستخدمين النشطين (حد أقصى 2)
const chatRef=db.ref('chat');

const secretBtn=document.getElementById('secretBtn');
const passOverlay=document.getElementById('passOverlay');
const chatOverlay=document.getElementById('chatOverlay');
const blockOverlay=document.getElementById('blockOverlay');
const passBtn=document.getElementById('passBtn');
const passInput=document.getElementById('passInput');
const sendBtn=document.getElementById('sendBtn');
const msgInput=document.getElementById('msgInput');
const messages=document.getElementById('messages');

secretBtn.onclick=()=>passOverlay.style.display='flex';

passBtn.onclick=enterChat;
passInput.onkeyup=(e)=>{ if(e.key==='Enter') enterChat(); };

function enterChat(){
  if(passInput.value!=='blobif') return;

  lockRef.transaction(current=>{
    current=current||{};
    if(current[uid]) return current; // نفس المستخدم
    if(Object.keys(current).length>=2) return; // رفض الطرف الثالث
    current[uid]=true; return current;
  },(err,committed)=>{
    passOverlay.style.display='none';
    if(!committed){ blockOverlay.style.display='flex'; return; }
    lockRef.child(uid).onDisconnect().remove();
    chatOverlay.style.display='flex';
  });
}

function sendMsg(){
  if(!msgInput.value.trim()) return;
  const r=chatRef.push();
  r.set({text:msgInput.value,uid,time:Date.now()});
  setTimeout(()=>r.remove(),5000);
  msgInput.value='';
}

sendBtn.onclick=sendMsg;
msgInput.onkeyup=(e)=>{ if(e.key==='Enter') sendMsg(); };

chatRef.on('child_added',s=>{
  const d=s.val(); if(!d) return;
  const m=document.createElement('div');
  m.className='msg '+(d.uid===uid?'me':'other');
  m.textContent=d.text;
  messages.appendChild(m);
  messages.scrollTop=messages.scrollHeight;
  setTimeout(()=>m.remove(),5000);
});
</script>
</body>
</html>
