<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Private Secure Chat</title>

<style>
body{margin:0;font-family:tahoma;background:#f3f3f3}
header{background:#222;color:#fff;padding:20px;text-align:center}
#hiddenBtn{position:fixed;bottom:10px;left:10px;width:40px;height:40px;
background:#f3f3f3;border:none;z-index:1000}
.overlay{position:fixed;inset:0;display:none;
background:rgba(0,0,0,.85);justify-content:center;align-items:center}
.box{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:350px}
input,button{width:100%;padding:12px;margin-top:10px;font-size:16px}
button{background:#222;color:#fff;border:none;border-radius:6px}
#chat{display:none;flex-direction:column;height:100%}
#msgs{flex:1;overflow:auto;padding:10px}
.msg{padding:10px;margin:6px 0;border-radius:14px;max-width:80%}
.me{background:#cdefff;margin-left:auto}
.other{background:#eee}
#sendArea{display:flex;border-top:1px solid #ccc}
#sendArea input{flex:1;border:none}
#sendArea button{width:auto;padding:0 18px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>

<body>

<header>حكمة اليوم: الخصوصية مسؤولية</header>
<button id="hiddenBtn"></button>

<div id="passBox" class="overlay">
  <div class="box">
    <div>كلمة المرور</div>
    <input id="pass">
    <button onclick="login()">دخول</button>
  </div>
</div>

<div id="block" class="overlay">
  <div class="box">❌ الشات مشغول بطرفين</div>
</div>

<div id="chatBox" class="overlay">
  <div class="box" id="chat">
    <div id="msgs"></div>
    <div id="sendArea">
      <input id="txt" placeholder="رسالة">
      <button onclick="send()">إرسال</button>
    </div>
  </div>
</div>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyDBADAFbHjg8Dq10vR1l9yMImoBSFs_70M",
  authDomain: "todayquote-3a22b.firebaseapp.com",
  databaseURL: "https://todayquote-3a22b-default-rtdb.firebaseio.com"
});
firebase.auth().signInAnonymously();
const db=firebase.database();

/* UID */
let uid=localStorage.uid||Math.random().toString(36).slice(2);
localStorage.uid=uid;

/* DOM */
hiddenBtn.onclick=()=>passBox.style.display="flex";

/* دخول بدون transaction (الحل الحقيقي) */
async function login(){
  if(pass.value!=="blobif") return;

  const snap=await db.ref("users").once("value");
  const users=snap.val()||{};
  if(Object.keys(users).length>=2 && !users[uid]){
    passBox.style.display="none";
    block.style.display="flex";
    return;
  }

  await db.ref("users/"+uid).set(true);
  db.ref("users/"+uid).onDisconnect().remove();

  passBox.style.display="none";
  chatBox.style.display="flex";
  chat.style.display="flex";
}

/* تشفير بسيط */
async function enc(t){
  return btoa(unescape(encodeURIComponent(t)));
}
async function dec(t){
  return decodeURIComponent(escape(atob(t)));
}

/* رسائل */
async function send(){
  if(!txt.value) return;
  const m=db.ref("msgs").push();
  m.set({u:uid,t:await enc(txt.value)});
  setTimeout(()=>m.remove(),5000);
  txt.value="";
}

db.ref("msgs").on("child_added",async s=>{
  const d=s.val(); if(!d)return;
  const div=document.createElement("div");
  div.className="msg "+(d.u===uid?"me":"other");
  div.textContent=await dec(d.t);
  msgs.appendChild(div);
  setTimeout(()=>div.remove(),5000);
});

/* تنظيف */
db.ref("users").on("value",s=>{
  if(!s.exists()) db.ref("msgs").remove();
});
</script>

</body>
</html>
